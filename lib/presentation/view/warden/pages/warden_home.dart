import 'package:flutter/material.dart';
import 'package:hostel_mgmt/core/enums/actions.dart';
import 'package:hostel_mgmt/core/enums/enum.dart';
import 'package:hostel_mgmt/models/request_model.dart';
import 'package:provider/provider.dart';
import 'package:hostel_mgmt/presentation/view/warden/state/warden_home_state.dart';
import 'package:hostel_mgmt/presentation/view/warden/controller/warden_home_controller.dart';
import 'package:hostel_mgmt/presentation/components/simple_request_card.dart';

class WardenHomePage extends StatelessWidget {
  final TimelineActor actor;
  WardenHomePage({Key? key, required this.actor}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Consumer<WardenHomeState>(
      builder: (context, state, _) {
        if (!state.isLoading && state.currentOnScreenRequests.isEmpty) {
          WidgetsBinding.instance.addPostFrameCallback((_) {
            WardenHomeController(state).fetchRequests();
          });
        }
        final WardenHomeController controller = WardenHomeController(state);

        if (state.isLoading) {
          return Scaffold(
            appBar: AppBar(
              title: const Text('Student Requests'),
              centerTitle: true,
            ),
            body: const Center(child: CircularProgressIndicator()),
          );
        } else if (state.isErrored) {
          return Scaffold(
            appBar: AppBar(
              title: const Text('Student Requests'),
              centerTitle: true,
            ),
            body: Center(
              child: Text(
                state.errorMessage,
                style: const TextStyle(color: Colors.red, fontSize: 16),
              ),
            ),
          );
        } else {
          final List<RequestModel> requests = state.currentOnScreenRequests;
          return Scaffold(
            appBar: AppBar(
              title: const Text('Student Requests'),
              centerTitle: true,
            ),
            body: Column(
              children: [
                Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: TextField(
                    controller: state.filterController,
                    decoration: InputDecoration(
                      hintText: 'Search by student name...',
                      prefixIcon: const Icon(Icons.search),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                  ),
                ),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16.0),
                  child: Row(
                    children: [
                      Expanded(
                        child: ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: state.isActioning
                                ? Colors.grey[300]
                                : Colors.red,
                            foregroundColor: state.isActioning
                                ? Colors.white
                                : Colors.black,
                          ),
                          onPressed: () => controller.acceptRequest(),
                          child: actor == TimelineActor.assistentWarden
                              ? Text(RequestAction.cancel.name)
                              : Text(RequestAction.reject.name),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: state.isActioning
                                ? Colors.grey[300]
                                : Colors.green,
                            foregroundColor: state.isActioning
                                ? Colors.white
                                : Colors.black,
                          ),
                          onPressed: () => controller.rejectRequest(),
                          child: actor == TimelineActor.assistentWarden
                              ? Text(RequestAction.refer.name)
                              : Text(RequestAction.approve.name),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 12),
                Expanded(
                  child: requests.isEmpty
                      ? const Center(child: Text('No requests found.'))
                      : state.isActioning
                      ? Center(child: CircularProgressIndicator())
                      : ListView.builder(
                          itemCount: requests.length,
                          itemBuilder: (context, index) {
                            final req = requests[index];
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16.0,
                                vertical: 8.0,
                              ),
                              child: SimpleRequestCard(
                                name:
                                    req.studentAction!.studentProfileModel.name,
                                requestType: req.requestType,
                                fromDate: req.appliedFrom,
                                toDate: req.appliedTo,
                                status: req.status,
                                statusDate: req.lastUpdatedAt,
                              ),
                            );
                          },
                        ),
                ),
              ],
            ),
          );
        }
      },
    );
  }
}
